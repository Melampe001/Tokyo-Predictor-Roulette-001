name: CI/CD - Build, Test and Release

# Workflow optimizado para build, test y release automatizado
# Se ejecuta en push/PR a main y develop para testing
# Solo crea releases firmados en push a main

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ main, develop ]

# Permisos necesarios
permissions:
  contents: write  # Para crear releases
  pull-requests: read

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout del cÃ³digo
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2. Setup Java 17 (requerido para Flutter/Android)
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'
      
      # 3. Setup Flutter (latest stable)
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      # 4. Setup Python 3.11 (para scripts de automatizaciÃ³n)
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # 5. Instalar dependencias de Python si existe requirements.txt
      - name: Install Python dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          elif [ -f scripts/automation/requirements.txt ]; then
            pip install -r scripts/automation/requirements.txt
          else
            echo "No requirements.txt found, skipping Python dependencies"
          fi
      
      # 6. Verificar instalaciÃ³n de Flutter
      - name: Run flutter doctor
        run: flutter doctor -v
      
      # 7. Obtener dependencias de Flutter
      - name: Get Flutter dependencies
        run: flutter pub get
      
      # 8. Analizar cÃ³digo (lint)
      - name: Analyze code
        run: flutter analyze --no-fatal-infos
      
      # 9. Ejecutar tests unitarios
      - name: Run tests
        run: flutter test --coverage
      
      # 10. Subir reporte de coverage
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
      
      # 11. Build debug APK
      - name: Build debug APK
        run: flutter build apk --debug
      
      # 12. Verificar que el APK se generÃ³ correctamente
      - name: Verify debug APK
        run: |
          if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
            echo "âœ“ Debug APK generated successfully"
            ls -lh build/app/outputs/flutter-apk/app-debug.apk
          else
            echo "âœ— Error: Debug APK not found"
            exit 1
          fi
      
      # 13. Subir debug APK como artifact
      - name: Upload debug APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk-${{ github.sha }}
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7
          compression-level: 6
  
  release:
    name: Build and Release Signed APK/AAB
    runs-on: ubuntu-latest
    needs: build-and-test
    # Solo ejecutar en push a main (no en PRs ni en develop)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      # 1. Checkout del cÃ³digo
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2. Setup Java 17
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'
      
      # 3. Setup Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      # 4. Obtener dependencias de Flutter
      - name: Get Flutter dependencies
        run: flutter pub get
      
      # 5. Decodificar keystore desde secretos de GitHub
      - name: Decode keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "âš ï¸  WARNING: KEYSTORE_BASE64 secret not configured"
            echo "Release will be built but NOT signed"
            exit 0
          fi
          echo "Decoding keystore..."
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/keystore.jks
          echo "âœ“ Keystore decoded successfully"
          ls -lh android/app/keystore.jks
      
      # 6. Crear archivo key.properties con credenciales del keystore
      - name: Create key.properties
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          if [ -z "$KEYSTORE_PASSWORD" ]; then
            echo "âš ï¸  WARNING: Keystore secrets not fully configured"
            exit 0
          fi
          echo "Creating key.properties..."
          cat > android/key.properties << EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=keystore.jks
          EOF
          echo "âœ“ key.properties created successfully"
      
      # 7. Build release APK
      - name: Build release APK
        run: |
          echo "Building release APK..."
          flutter build apk --release
          echo "âœ“ Release APK built successfully"
      
      # 8. Build App Bundle (AAB) para Google Play
      - name: Build release AAB
        run: |
          echo "Building release AAB..."
          flutter build appbundle --release
          echo "âœ“ Release AAB built successfully"
      
      # 9. Verificar que los builds se generaron
      - name: Verify release builds
        run: |
          echo "Verifying release APK..."
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "âœ“ Release APK found"
            ls -lh build/app/outputs/flutter-apk/app-release.apk
          else
            echo "âœ— Release APK not found"
            exit 1
          fi
          
          echo "Verifying release AAB..."
          if [ -f "build/app/outputs/bundle/release/app-release.aab" ]; then
            echo "âœ“ Release AAB found"
            ls -lh build/app/outputs/bundle/release/app-release.aab
          else
            echo "âœ— Release AAB not found"
            exit 1
          fi
      
      # 10. Generar checksums SHA-256
      - name: Generate checksums
        run: |
          cd build/app/outputs/flutter-apk
          sha256sum app-release.apk > app-release.apk.sha256
          cd ../../../../
          
          cd build/app/outputs/bundle/release
          sha256sum app-release.aab > app-release.aab.sha256
          cd ../../../../../
          
          echo "âœ“ Checksums generated"
      
      # 11. Subir release APK como artifact
      - name: Upload release APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-apk-${{ github.sha }}
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/flutter-apk/app-release.apk.sha256
          retention-days: 30
          compression-level: 6
      
      # 12. Subir release AAB como artifact
      - name: Upload release AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-aab-${{ github.sha }}
          path: |
            build/app/outputs/bundle/release/app-release.aab
            build/app/outputs/bundle/release/app-release.aab.sha256
          retention-days: 30
          compression-level: 6
      
      # 13. Crear GitHub Release si es un tag
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/flutter-apk/app-release.apk.sha256
            build/app/outputs/bundle/release/app-release.aab
            build/app/outputs/bundle/release/app-release.aab.sha256
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ðŸŽ‰ Tokyo Roulette Predictor Release
            
            ### ðŸ“± Installation
            Download the APK file for direct installation on Android devices.
            
            ### ðŸ“¦ Available Files
            - **APK**: For direct Android installation
            - **AAB**: For Google Play Store distribution
            - **SHA256**: Checksums for integrity verification
            
            ### ðŸ”’ Integrity Verification
            Verify the SHA-256 checksum before installing:
            ```bash
            sha256sum -c app-release.apk.sha256
            ```
            
            ### âš ï¸  Important Notice
            This is an educational simulation app. It does not promote or facilitate real gambling.
            
            ---
            **Version**: ${{ github.ref_name }}
            **Date**: ${{ github.event.head_commit.timestamp }}
            **Commit**: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # 14. Mostrar resumen del release
      - name: Release summary
        run: |
          echo "# ðŸŽ‰ Release Build Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts Generated:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Release APK" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Release AAB (App Bundle)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ SHA-256 Checksums" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Download Artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "Go to the Actions tab and download the artifacts from this workflow run." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "## GitHub Release:" >> $GITHUB_STEP_SUMMARY
            echo "Release published at: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          fi
