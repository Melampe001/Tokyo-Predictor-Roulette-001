# Tokyo Predictor Roulette - CI/CD Pipeline
# Workflow de integración continua para test, lint y build APK
# Para aprobación Google Play Store

name: CI - Test, Lint & Build APK

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:  # Permite ejecución manual

permissions:
  contents: read

jobs:
  # Job 1: Análisis de código y linting
  analyze:
    name: Analyze & Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Run analyzer
      run: flutter analyze --no-fatal-infos
    
    - name: Check formatting
      run: dart format --set-exit-if-changed lib/ test/
      continue-on-error: true

  # Job 2: Ejecutar tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: analyze
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Run unit tests
      run: flutter test --coverage
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/
        retention-days: 7
      if: always()

  # Job 3: Build APK para release
  build-apk:
    name: Build Release APK
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true
    
    - name: Get dependencies
      run: flutter pub get
    
    # Configurar signing para release (usando secretos de GitHub)
    - name: Configure signing
      if: ${{ github.event_name != 'pull_request' }}
      run: |
        echo "Setting up keystore..."
        if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/release-keystore.jks
          echo "storeFile=release-keystore.jks" >> android/key.properties
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
        fi
      continue-on-error: true
    
    - name: Build APK (Release)
      run: flutter build apk --release
    
    - name: Verify APK
      run: |
        echo "============================================"
        echo "Tokyo Predictor Roulette - Build Info"
        echo "============================================"
        if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
          echo "✓ APK built successfully"
          ls -lh build/app/outputs/flutter-apk/app-release.apk
          echo "Package: com.tokraggcorp.tokyopredictorroulett"
          echo "Support: tokraagcorp@gmail.com"
        else
          echo "✗ APK not found"
          exit 1
        fi
        echo "============================================"
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: tokyo-predictor-roulette-apk
        path: build/app/outputs/flutter-apk/app-release.apk
        retention-days: 30
        compression-level: 9

  # Job 4: Build AAB para Play Store
  build-aab:
    name: Build Release AAB (Play Store)
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name != 'pull_request'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Configure signing
      if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
      run: |
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/release-keystore.jks
        echo "storeFile=release-keystore.jks" >> android/key.properties
        echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
        echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
        echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
      continue-on-error: true
    
    - name: Build AAB (App Bundle)
      run: flutter build appbundle --release
    
    - name: Upload AAB artifact
      uses: actions/upload-artifact@v4
      with:
        name: tokyo-predictor-roulette-aab
        path: build/app/outputs/bundle/release/app-release.aab
        retention-days: 30
        compression-level: 9
      if: success()
