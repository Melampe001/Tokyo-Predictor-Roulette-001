# .github/workflows/auto-close-duplicates.yml
#
# ðŸ¤– Workflow para detectar y cerrar automÃ¡ticamente issues duplicados
#
# Triggers:
#   - Cuando se abre un issue nuevo
#   - Cuando se agrega un label a un issue
#   - Semanalmente (domingo a medianoche UTC)

name: Auto-close Duplicate Issues

on:
  issues:
    types: [opened, labeled]
  schedule:
    - cron: '0 0 * * 0'  # Domingo a medianoche UTC
  workflow_dispatch:  # Permite ejecuciÃ³n manual

permissions:
  issues: write
  contents: read

jobs:
  close-duplicates:
    runs-on: ubuntu-latest
    name: Detectar y cerrar issues duplicados
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Detectar y cerrar duplicados
        uses: actions/github-script@v7
        with:
          script: |
            const duplicatePatterns = [
              'Set up Copilot instructions',
              'Copilot setup',
              'Configure Copilot',
              'copilot-instructions',
              'GitHub Copilot configuration'
            ];
            
            console.log('ðŸ” Buscando issues duplicados...');
            
            // Obtener todos los issues abiertos
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            console.log(`ðŸ“‹ Total de issues abiertos: ${issues.length}`);
            
            // Buscar duplicados basados en patrones
            const duplicates = issues.filter(issue => {
              // No procesar PRs
              if (issue.pull_request) return false;
              
              return duplicatePatterns.some(pattern => 
                issue.title.toLowerCase().includes(pattern.toLowerCase()) ||
                (issue.body && issue.body.toLowerCase().includes(pattern.toLowerCase()))
              );
            });
            
            console.log(`ðŸŽ¯ Issues que coinciden con patrones: ${duplicates.length}`);
            
            if (duplicates.length === 0) {
              console.log('âœ… No se encontraron issues duplicados');
              return;
            }
            
            // Ordenar por fecha de creaciÃ³n (mÃ¡s antiguos primero)
            duplicates.sort((a, b) => 
              new Date(a.created_at) - new Date(b.created_at)
            );
            
            // Si hay mÃ¡s de 1, cerrar los mÃ¡s antiguos excepto el mÃ¡s reciente
            if (duplicates.length > 1) {
              console.log(`ðŸ§¹ Se encontraron ${duplicates.length} duplicados. Cerrando los mÃ¡s antiguos...`);
              
              const toClose = duplicates.slice(0, -1);  // Todos excepto el Ãºltimo (mÃ¡s reciente)
              const masterIssue = duplicates[duplicates.length - 1];
              
              for (const issue of toClose) {
                console.log(`  ðŸ”„ Cerrando issue #${issue.number}: ${issue.title}`);
                
                try {
                  // Agregar comentario explicativo
                  const closeComment = [
                    'ðŸ¤– **Issue duplicado cerrado automÃ¡ticamente**',
                    '',
                    'Este issue es un duplicado detectado por el sistema automÃ¡tico.',
                    '',
                    `**Issue maestro**: #${masterIssue.number}`,
                    '**ConfiguraciÃ³n actual**: `.github/copilot-instructions.md`',
                    '**DocumentaciÃ³n**: `docs/COPILOT_SETUP.md`',
                    '',
                    `La configuraciÃ³n de Copilot ya estÃ¡ implementada en este repositorio. Si necesitas hacer cambios, por favor comenta en el issue maestro #${masterIssue.number}.`,
                    '',
                    '---',
                    '_Cerrado automÃ¡ticamente por Bot_Cleanup | Workflow: auto-close-duplicates.yml_'
                  ].join('\n');
                  
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: closeComment
                  });
                  
                  // Agregar label de duplicado
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    labels: ['duplicate', 'auto-closed']
                  });
                  
                  // Cerrar el issue
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    state: 'closed',
                    state_reason: 'not_planned'
                  });
                  
                  console.log(`  âœ… Issue #${issue.number} cerrado exitosamente`);
                } catch (error) {
                  console.error(`  âŒ Error cerrando issue #${issue.number}: ${error.message}`);
                }
              }
              
              // Comentar en el issue maestro
              try {
                const masterComment = [
                  'ðŸ¤– **Sistema de limpieza automÃ¡tica activado**',
                  '',
                  `Se cerraron ${toClose.length} issue(s) duplicado(s):`,
                  ...toClose.map(i => `- #${i.number}: ${i.title}`),
                  '',
                  'Este es el issue maestro para la configuraciÃ³n de Copilot.',
                  '',
                  '---',
                  '_Actualizado automÃ¡ticamente por Bot_Cleanup_'
                ].join('\n');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: masterIssue.number,
                  body: masterComment
                });
                
                // Agregar label de master issue
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: masterIssue.number,
                  labels: ['copilot', 'master-issue', 'documentation']
                });
                
                console.log(`  ðŸ“Œ Issue maestro actualizado: #${masterIssue.number}`);
              } catch (error) {
                console.error(`  âš ï¸  Error actualizando issue maestro: ${error.message}`);
              }
              
              console.log('');
              console.log('âœ… Proceso de limpieza completado');
              console.log(`ðŸ“Š EstadÃ­sticas:`);
              console.log(`   - Issues procesados: ${duplicates.length}`);
              console.log(`   - Issues cerrados: ${toClose.length}`);
              console.log(`   - Issue maestro: #${masterIssue.number}`);
            } else {
              console.log('â„¹ï¸  Solo hay 1 issue relacionado con Copilot, no hay duplicados que cerrar');
            }
      
      - name: Crear resumen
        if: always()
        run: |
          echo "## ðŸ§¹ Resumen de Limpieza de Duplicados" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Workflow ejecutado exitosamente" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repositorio**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Para mÃ¡s detalles, revisa los logs del workflow." >> $GITHUB_STEP_SUMMARY
