name: PR Checks - Pull Request Validation

# Ejecutar solo en pull requests
on:
  pull_request:
    types: [opened, synchronize, reopened]

# Permisos para comentar en PRs
permissions:
  contents: read
  pull-requests: write

jobs:
  # Job 1: Verificar formato
  format-check:
    name: Verificar Formato de C√≥digo
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout del repositorio
      uses: actions/checkout@v4
    
    - name: Configurar Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true
    
    - name: Verificar formato
      id: format
      run: |
        dart format --set-exit-if-changed . > format-output.txt 2>&1 || echo "format_failed=true" >> $GITHUB_OUTPUT
        cat format-output.txt
    
    - name: Comentar en PR si hay errores de formato
      if: steps.format.outputs.format_failed == 'true'
      uses: actions/github-script@v8
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '## ‚ö†Ô∏è Errores de Formato\n\nAlgunos archivos no est√°n correctamente formateados.\n\nEjecuta `dart format .` para corregirlos.'
          })

  # Job 2: Cobertura de tests
  coverage-check:
    name: Verificar Cobertura de Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout del repositorio
      uses: actions/checkout@v4
    
    - name: Configurar Java 11
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'
    
    - name: Configurar Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true
    
    - name: Obtener dependencias
      run: flutter pub get
    
    - name: Ejecutar tests con coverage
      run: flutter test --coverage
    
    - name: Instalar lcov
      run: sudo apt-get install -y lcov
    
    - name: Calcular cobertura
      id: coverage
      run: |
        COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep "lines" | grep -oP '\d+\.\d+(?=%)')
        echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
        echo "Cobertura: $COVERAGE%"
    
    - name: Verificar umbral de cobertura
      id: check_coverage
      run: |
        THRESHOLD=80
        COVERAGE=${{ steps.coverage.outputs.percentage }}
        
        if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
          echo "coverage_low=true" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è Cobertura baja: $COVERAGE% (umbral: $THRESHOLD%)"
        else
          echo "coverage_low=false" >> $GITHUB_OUTPUT
          echo "‚úì Cobertura adecuada: $COVERAGE% (umbral: $THRESHOLD%)"
        fi
    
    - name: Comentar cobertura en PR
      uses: actions/github-script@v8
      with:
        script: |
          const coverage = '${{ steps.coverage.outputs.percentage }}';
          const isLow = '${{ steps.check_coverage.outputs.coverage_low }}' === 'true';
          const threshold = 80;
          
          const emoji = isLow ? '‚ö†Ô∏è' : '‚úÖ';
          const status = isLow ? 'BAJA' : 'OK';
          
          let body = `## ${emoji} Cobertura de Tests: ${status}\n\n`;
          body += `**Cobertura actual**: ${coverage}%\n`;
          body += `**Umbral requerido**: ${threshold}%\n\n`;
          
          if (isLow) {
            body += '‚ö†Ô∏è La cobertura est√° por debajo del umbral. Considera agregar m√°s tests.\n';
          } else {
            body += '‚úÖ La cobertura cumple con el umbral requerido.\n';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

  # Job 3: Escaneo de seguridad
  security-check:
    name: Escaneo de Seguridad
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout del repositorio
      uses: actions/checkout@v4
    
    - name: Ejecutar security scanner
      id: security
      run: |
        chmod +x scripts/security_scanner.sh
        scripts/security_scanner.sh --no-fail --report security-report-pr.txt || true
    
    - name: Leer reporte de seguridad
      id: read_report
      run: |
        if [ -f "security-report-pr.txt" ]; then
          # Extraer n√∫mero de issues
          ISSUES=$(grep "Total de issues encontrados:" security-report-pr.txt | grep -oP '\d+' || echo "0")
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
        else
          echo "issues=0" >> $GITHUB_OUTPUT
        fi
    
    - name: Comentar en PR
      uses: actions/github-script@v8
      with:
        script: |
          const issues = parseInt('${{ steps.read_report.outputs.issues }}');
          
          let body = '## üîí Escaneo de Seguridad\n\n';
          
          if (issues === 0) {
            body += '‚úÖ No se encontraron issues de seguridad.\n';
          } else {
            body += `‚ö†Ô∏è Se encontraron ${issues} posibles issues de seguridad.\n\n`;
            body += 'Revisa el reporte completo en los artifacts del workflow.\n';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
    
    - name: Subir reporte
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-report-pr
        path: security-report-pr.txt
        retention-days: 30

  # Job 4: Verificar secretos hardcodeados
  secrets-check:
    name: Verificar Secretos Hardcodeados
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout del repositorio
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Buscar secretos hardcodeados
      id: secrets
      run: |
        # Patrones de secretos comunes
        PATTERNS=(
          "AIza[0-9A-Za-z-_]{35}"
          "sk_live_[0-9a-zA-Z]{24,}"
          "sk_test_[0-9a-zA-Z]{24,}"
          "AKIA[0-9A-Z]{16}"
        )
        
        FOUND=false
        for pattern in "${PATTERNS[@]}"; do
          if git diff origin/${{ github.base_ref }}...HEAD | grep -E "$pattern"; then
            FOUND=true
            break
          fi
        done
        
        if [ "$FOUND" = true ]; then
          echo "secrets_found=true" >> $GITHUB_OUTPUT
        else
          echo "secrets_found=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Comentar si se encuentran secretos
      if: steps.secrets.outputs.secrets_found == 'true'
      uses: actions/github-script@v8
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '## üö® ALERTA: Posibles Secretos Detectados\n\n‚ö†Ô∏è Se detectaron patrones que parecen API keys o secretos hardcodeados.\n\n**NUNCA** commitees secretos al repositorio.\n\nRevisa los cambios y remueve cualquier secreto antes de hacer merge.'
          });

  # Job 5: Resumen de PR
  pr-summary:
    name: Resumen de PR
    runs-on: ubuntu-latest
    needs: [format-check, coverage-check, security-check, secrets-check]
    if: always()
    
    steps:
    - name: Checkout del repositorio
      uses: actions/checkout@v4
    
    - name: Generar resumen
      uses: actions/github-script@v8
      with:
        script: |
          const formatStatus = '${{ needs.format-check.result }}';
          const coverageStatus = '${{ needs.coverage-check.result }}';
          const securityStatus = '${{ needs.security-check.result }}';
          const secretsStatus = '${{ needs.secrets-check.result }}';
          
          const getEmoji = (status) => {
            if (status === 'success') return '‚úÖ';
            if (status === 'failure') return '‚ùå';
            return '‚ö†Ô∏è';
          };
          
          let body = '## üìä Resumen de Validaciones de PR\n\n';
          body += '| Check | Estado |\n';
          body += '|-------|--------|\n';
          body += `| Formato de c√≥digo | ${getEmoji(formatStatus)} ${formatStatus} |\n`;
          body += `| Cobertura de tests | ${getEmoji(coverageStatus)} ${coverageStatus} |\n`;
          body += `| Seguridad | ${getEmoji(securityStatus)} ${securityStatus} |\n`;
          body += `| Secretos | ${getEmoji(secretsStatus)} ${secretsStatus} |\n\n`;
          
          const allSuccess = [formatStatus, coverageStatus, securityStatus, secretsStatus]
            .every(s => s === 'success');
          
          if (allSuccess) {
            body += '‚úÖ Todas las validaciones pasaron exitosamente.\n';
          } else {
            body += '‚ö†Ô∏è Algunas validaciones fallaron o tienen advertencias. Revisa los checks individuales.\n';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
