name: Flutter CI - Build APK

# Este workflow construye el APK de Android autom谩ticamente en cada push y PR
on:
  push:
    branches: 
      - main
      - develop
      - 'feature/**'
      - 'release/**'
  pull_request:
    branches: 
      - main
      - develop

  # Permite ejecuci贸n manual desde la pesta帽a Actions
  workflow_dispatch:

# Variables de entorno globales
env:
  FLUTTER_VERSION: '3.24.0'  # Versi贸n de Flutter a usar
  JAVA_VERSION: '17'         # Versi贸n de Java requerida

jobs:
  # Job 1: An谩lisis y pruebas
  analyze-and-test:
    name: An谩lisis de c贸digo y pruebas
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout del c贸digo
        uses: actions/checkout@v4
      
      - name: Configurar Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
      
      - name: Configurar Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Verificar instalaci贸n de Flutter
        run: |
          flutter --version
          flutter doctor -v
      
      - name: Obtener dependencias
        run: flutter pub get
      
      - name: Verificar formato de c贸digo
        run: flutter format --set-exit-if-changed .
        continue-on-error: true
      
      - name: Analizar c贸digo
        run: flutter analyze
      
      - name: Ejecutar pruebas unitarias
        run: flutter test --coverage
      
      - name: Subir reporte de cobertura
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # Job 2: Construir APK (ejecuta despu茅s de las pruebas)
  build-apk:
    name: Construir APK Release
    needs: analyze-and-test
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    # Matriz para probar con diferentes canales de Flutter (opcional)
    strategy:
      matrix:
        flutter-channel: ['stable']
        # Descomentar para probar con m煤ltiples canales:
        # flutter-channel: ['stable', 'beta']
    
    steps:
      - name: Checkout del c贸digo
        uses: actions/checkout@v4
      
      - name: Configurar Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
      
      - name: Configurar Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ matrix.flutter-channel }}
          cache: true
      
      - name: Obtener dependencias
        run: flutter pub get
      
      - name: Limpiar build anterior
        run: flutter clean
      
      # Configurar firma del APK (si se proporcionan secretos)
      - name: Configurar keystore para firma
        if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "Configurando keystore..."
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/upload-keystore.jks
          
          # Crear key.properties
          cat > android/key.properties << EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=upload-keystore.jks
          EOF
          
          echo "Keystore configurado exitosamente"
      
      - name: Construir APK release
        run: flutter build apk --release --split-per-abi
        
      - name: Construir APK universal
        run: flutter build apk --release
      
      # Listar APKs generados
      - name: Listar APKs generados
        run: |
          echo "APKs generados:"
          ls -lh build/app/outputs/flutter-apk/
      
      # Renombrar APKs con informaci贸n de versi贸n
      - name: Preparar APKs para publicaci贸n
        run: |
          # Obtener versi贸n del pubspec.yaml
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # Crear directorio para artefactos
          mkdir -p artifacts
          
          # Copiar APKs al directorio de artefactos
          cp build/app/outputs/flutter-apk/*.apk artifacts/
          
          # Listar artefactos
          echo "Artefactos preparados:"
          ls -lh artifacts/
      
      # Subir APKs como artefactos del workflow
      - name: Subir APK Universal como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: apk-universal-${{ matrix.flutter-channel }}
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30
      
      - name: Subir APKs por arquitectura como artefactos
        uses: actions/upload-artifact@v4
        with:
          name: apk-split-per-abi-${{ matrix.flutter-channel }}
          path: |
            build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
            build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
            build/app/outputs/flutter-apk/app-x86_64-release.apk
          retention-days: 30
      
      # Generar reporte de tama帽o del APK
      - name: Generar reporte de tama帽o
        run: |
          echo "##  Reporte de Tama帽o de APKs" > apk-size-report.md
          echo "" >> apk-size-report.md
          echo "| APK | Tama帽o |" >> apk-size-report.md
          echo "|-----|--------|" >> apk-size-report.md
          
          for apk in build/app/outputs/flutter-apk/*.apk; do
            if [ -f "$apk" ]; then
              filename=$(basename "$apk")
              size=$(ls -lh "$apk" | awk '{print $5}')
              echo "| $filename | $size |" >> apk-size-report.md
            fi
          done
          
          echo "" >> apk-size-report.md
          echo "Canal de Flutter: ${{ matrix.flutter-channel }}" >> apk-size-report.md
          echo "Versi贸n de la app: ${{ env.VERSION }}" >> apk-size-report.md
          
          cat apk-size-report.md
      
      - name: Subir reporte de tama帽o
        uses: actions/upload-artifact@v4
        with:
          name: apk-size-report-${{ matrix.flutter-channel }}
          path: apk-size-report.md
          retention-days: 30

  # Job 3: Construir App Bundle (para Google Play Store)
  build-appbundle:
    name: Construir App Bundle (AAB)
    needs: analyze-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout del c贸digo
        uses: actions/checkout@v4
      
      - name: Configurar Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
      
      - name: Configurar Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Obtener dependencias
        run: flutter pub get
      
      # Configurar firma del App Bundle
      - name: Configurar keystore para firma
        if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/upload-keystore.jks
          
          cat > android/key.properties << EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=upload-keystore.jks
          EOF
      
      - name: Construir App Bundle
        run: flutter build appbundle --release
      
      - name: Subir App Bundle como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: app-bundle-release
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

  # Job 4: Resumen del build
  build-summary:
    name: Resumen del Build
    needs: [build-apk, build-appbundle]
    runs-on: ubuntu-latest
    if: always()
    
    permissions:
      contents: read
    
    steps:
      - name: Generar resumen
        run: |
          echo "##  Build Completado" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Estado de los Jobs:" >> $GITHUB_STEP_SUMMARY
          echo "- An谩lisis y pruebas: ${{ needs.analyze-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build APK: ${{ needs.build-apk.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build App Bundle: ${{ needs.build-appbundle.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "###  Artefactos Disponibles:" >> $GITHUB_STEP_SUMMARY
          echo "Los APKs y App Bundles est谩n disponibles en la pesta帽a 'Artifacts' de este workflow run." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "###  Pr贸ximos pasos:" >> $GITHUB_STEP_SUMMARY
          echo "1. Descarga los artefactos desde la pesta帽a 'Actions'" >> $GITHUB_STEP_SUMMARY
          echo "2. Prueba el APK en dispositivos f铆sicos" >> $GITHUB_STEP_SUMMARY
          echo "3. Si todo est谩 OK, procede con el release" >> $GITHUB_STEP_SUMMARY
