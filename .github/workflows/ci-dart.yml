name: Dart CI

on:
  pull_request:
    branches: ['**']
  push:
    branches: [main]
  workflow_dispatch:

env:
  BUILD_OUTPUT: 'build'  # Adjust this to match your build output directory (e.g., bin/, web/, or build/)

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1

      - name: Cache pub packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install dependencies
        run: dart pub get

      - name: Check formatting
        run: dart format --set-exit-if-changed .

  analyze:
    runs-on: ubuntu-latest
    needs: format
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1

      - name: Cache pub packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install dependencies
        run: dart pub get

      - name: Analyze code
        run: dart analyze

  test:
    runs-on: ubuntu-latest
    needs: analyze
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1

      - name: Cache pub packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install dependencies
        run: dart pub get

      - name: Run tests
        run: dart test

  build:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1

      - name: Cache pub packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install dependencies
        run: dart pub get

      - name: Build application
        run: |
          # TODO: Replace this placeholder with your actual build command
          # For example:
          # - For a Dart web app: dart compile js bin/main.dart -o ${{ env.BUILD_OUTPUT }}/main.js
          # - For a Dart server app: dart compile exe bin/main.dart -o ${{ env.BUILD_OUTPUT }}/main
          # - For Flutter web: flutter build web --release
          echo "Replace this with your actual build command"
          mkdir -p ${{ env.BUILD_OUTPUT }}
          echo "Build placeholder" > ${{ env.BUILD_OUTPUT }}/README.txt

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dart-app
          path: ${{ env.BUILD_OUTPUT }}
