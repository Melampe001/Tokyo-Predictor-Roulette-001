name: Welcome & Onboarding Premium Bot

# Welcome new contributors and celebrate milestones

on:
  issues:
    types: [opened]
  pull_request_target:
    types: [opened, closed]
  discussion:
    types: [created]

permissions:
  issues: write
  pull-requests: write
  discussions: write

jobs:
  welcome-new-contributor:
    name: Welcome First-Time Contributors
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    
    steps:
      - name: Check if first-time contributor
        uses: actions/github-script@v7
        id: check-first-time
        with:
          result-encoding: string
          script: |
            const { owner, repo } = context.repo;
            const sender = context.payload.sender.login;
            
            try {
              // Check if user has previous contributions
              const { data: issues } = await github.rest.issues.listForRepo({
                owner,
                repo,
                creator: sender,
                state: 'all',
                per_page: 100,
              });
              
              const { data: prs } = await github.rest.pulls.list({
                owner,
                repo,
                state: 'all',
                per_page: 100,
              });
              
              const userPRs = prs.filter(pr => pr.user.login === sender);
              
              // First contribution if this is their first issue/PR
              const isFirstTime = (issues.length <= 1 && userPRs.length === 0) || 
                                  (issues.length === 0 && userPRs.length <= 1);
              
              return isFirstTime.toString();
            } catch (error) {
              console.log('Error checking contribution history:', error);
              return 'true';  // Assume first time on error
            }
      
      - name: Welcome new issue creator
        if: github.event_name == 'issues' && steps.check-first-time.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const author = context.payload.sender.login;
            
            const welcomeMessage = `## ðŸ‘‹ Welcome to Tokyo Roulette Predictor!

Hi @${author}! Thank you for opening your first issue in our project. We're excited to have you here! ðŸŽ‰

### ðŸ“š Getting Started
- **Documentation**: Check out our [README](../README.md) and [Contributing Guide](../CONTRIBUTING.md)
- **Project Overview**: See [PROJECT_SUMMARY.md](../PROJECT_SUMMARY.md) for project details
- **Architecture**: Review [ARCHITECTURE.md](../docs/ARCHITECTURE.md) to understand the codebase

### ðŸ¤ What Happens Next?
1. A maintainer will review your issue
2. We may ask for clarification or additional details
3. If it's a bug, we'll investigate and work on a fix
4. If it's a feature request, we'll discuss feasibility and approach

### ðŸ’¡ Want to Contribute?
If you'd like to work on this issue yourself:
- Comment on this issue to express interest
- We'll provide guidance and answer questions
- Check out our [Contributing Guide](../CONTRIBUTING.md) for the process

### ðŸ”— Helpful Resources
- [User Guide](../docs/USER_GUIDE.md)
- [Health Agent Guide](../docs/HEALTH_AGENT.md)
- [Changelog](../CHANGELOG.md)

Thank you for helping improve Tokyo Roulette Predictor! ðŸŽ°âœ¨

---
*Automated welcome message by Welcome & Onboarding Premium Bot*`;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issue_number,
              body: welcomeMessage,
            });
            
            // Add welcome label
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: issue_number,
              labels: ['first-time-contributor'],
            });
      
      - name: Welcome new PR creator
        if: github.event_name == 'pull_request_target' && steps.check-first-time.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = context.issue.number;
            const author = context.payload.sender.login;
            
            const welcomeMessage = `## ðŸŽ‰ Welcome to Tokyo Roulette Predictor!

Hi @${author}! Thank you for your first pull request! We're thrilled to have you contribute to our project! ðŸš€

### ðŸ“‹ PR Review Process
1. **Automated Checks**: Our bots will run automated tests and quality checks
2. **Code Review**: A maintainer will review your changes
3. **Feedback**: We may request changes or clarifications
4. **Merge**: Once approved, we'll merge your contribution!

### âœ… Before Merge Checklist
Please ensure your PR:
- [ ] Passes all CI/CD checks
- [ ] Includes tests for new functionality
- [ ] Updates documentation if needed
- [ ] Follows our code style guidelines
- [ ] Has a clear description of changes

### ðŸŽ¯ Tips for Success
- **Respond to feedback**: Address review comments promptly
- **Keep it focused**: Smaller PRs are easier to review
- **Test locally**: Make sure tests pass before pushing
- **Ask questions**: Don't hesitate to ask for clarification

### ðŸ“š Resources
- [Contributing Guide](../CONTRIBUTING.md)
- [Code of Conduct](../CODE_OF_CONDUCT.md) (if available)
- [Architecture Guide](../docs/ARCHITECTURE.md)

### ðŸ¤ Need Help?
If you have questions or need assistance:
- Comment on this PR
- Mention @maintainers for help
- Check our documentation

Thank you for your contribution! We appreciate your effort and look forward to working with you! ðŸ™

---
*Automated welcome message by Welcome & Onboarding Premium Bot*`;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body: welcomeMessage,
            });
            
            // Add first-time contributor label
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pr_number,
              labels: ['first-time-contributor'],
            });
  
  thank-contributor:
    name: Thank Contributors on PR Merge
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target' && github.event.action == 'closed' && github.event.pull_request.merged == true
    
    steps:
      - name: Thank contributor
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = context.issue.number;
            const author = context.payload.pull_request.user.login;
            const pr_title = context.payload.pull_request.title;
            
            // Check if first-time contributor
            const labels = context.payload.pull_request.labels || [];
            const isFirstTime = labels.some(label => label.name === 'first-time-contributor');
            
            let thankYouMessage = '';
            
            if (isFirstTime) {
              thankYouMessage = `## ðŸŽŠ Congratulations on Your First Merged PR!

@${author}, your pull request has been merged! This is a significant milestone, and we're grateful for your contribution! ðŸŽ‰

### ðŸŒŸ What You've Accomplished
âœ… **Merged PR**: "${pr_title}"
âœ… **Became a contributor** to Tokyo Roulette Predictor
âœ… **Made open source better** with your work!

### ðŸš€ What's Next?
- Your changes are now part of the project!
- Check out other [open issues](../../issues) you might be interested in
- Join our community discussions
- Help review other PRs
- Share your experience with others

### ðŸ† Contributor Recognition
You're now an official contributor! Your name will appear in:
- Git history
- Contributors list
- Project acknowledgments

Thank you for your valuable contribution! We hope this is the first of many! ðŸ™Œ

---
*Automated message by Welcome & Onboarding Premium Bot*`;
            } else {
              thankYouMessage = `## ðŸŽ‰ Thank You for Your Contribution!

@${author}, your pull request has been merged! Thank you for improving Tokyo Roulette Predictor! ðŸš€

**Merged PR**: "${pr_title}"

Your contribution helps make this project better for everyone. We appreciate your continued support! ðŸ™

---
*Automated message by Welcome & Onboarding Premium Bot*`;
            }
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body: thankYouMessage,
            });
  
  celebrate-milestones:
    name: Celebrate Contributor Milestones
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target' && github.event.action == 'closed' && github.event.pull_request.merged == true
    
    steps:
      - name: Check milestones
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = context.issue.number;
            const author = context.payload.pull_request.user.login;
            
            try {
              // Get all merged PRs by this author
              const { data: prs } = await github.rest.pulls.list({
                owner,
                repo,
                state: 'closed',
                per_page: 100,
              });
              
              const authorMergedPRs = prs.filter(pr => 
                pr.user.login === author && pr.merged_at !== null
              );
              
              const prCount = authorMergedPRs.length;
              const milestones = [5, 10, 25, 50, 100];
              
              if (milestones.includes(prCount)) {
                const celebrationMessage = `## ðŸŽŠ MILESTONE ACHIEVEMENT! ðŸŽŠ

@${author} just reached an amazing milestone: **${prCount} merged pull requests!** ðŸŽ‰

### ðŸ† Outstanding Contribution
${prCount === 5 ? 'ðŸŒŸ **5 PRs** - You\'re becoming a regular contributor!' : ''}
${prCount === 10 ? 'â­ **10 PRs** - Double digits! You\'re a valuable team member!' : ''}
${prCount === 25 ? 'ðŸŒŸ **25 PRs** - Quarter century! You\'re a core contributor!' : ''}
${prCount === 50 ? 'ðŸ’Ž **50 PRs** - Half a hundred! You\'re a project champion!' : ''}
${prCount === 100 ? 'ðŸ† **100 PRs** - Triple digits! You\'re a legendary contributor!' : ''}

Thank you for your continued dedication to Tokyo Roulette Predictor! Your contributions make a real difference! ðŸ™Œ

Keep up the amazing work! ðŸš€

---
*Automated celebration by Welcome & Onboarding Premium Bot*`;
                
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: pr_number,
                  body: celebrationMessage,
                });
              }
            } catch (error) {
              console.log('Error checking milestones:', error);
            }
  
  provide-resources:
    name: Provide Contextual Resources
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    
    steps:
      - name: Analyze issue and provide resources
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const title = context.payload.issue.title.toLowerCase();
            const body = (context.payload.issue.body || '').toLowerCase();
            const content = `${title} ${body}`;
            
            const resources = [];
            
            // Provide relevant resources based on issue content
            if (content.includes('flutter') || content.includes('mobile') || content.includes('dart')) {
              resources.push('- [Flutter Documentation](https://flutter.dev/docs)');
              resources.push('- [Project Architecture](../docs/ARCHITECTURE.md)');
            }
            
            if (content.includes('python') || content.includes('ml') || content.includes('prediction')) {
              resources.push('- [Health Agent Documentation](../docs/HEALTH_AGENT.md)');
            }
            
            if (content.includes('install') || content.includes('setup') || content.includes('build')) {
              resources.push('- [Installation Guide](../README.md#installation)');
              resources.push('- [Build Instructions](../README.md#build-apk)');
            }
            
            if (content.includes('test') || content.includes('testing')) {
              resources.push('- [Testing Guide](../README.md#run-tests)');
            }
            
            if (content.includes('firebase') || content.includes('config')) {
              resources.push('- [Firebase Setup Guide](../docs/FIREBASE_SETUP.md)');
            }
            
            if (content.includes('contribute') || content.includes('contribution')) {
              resources.push('- [Contributing Guide](../CONTRIBUTING.md)');
            }
            
            if (resources.length > 0) {
              const resourceMessage = `### ðŸ“š Helpful Resources

Based on your issue, these resources might be helpful:

${resources.join('\n')}

---
*Provided by Welcome & Onboarding Premium Bot*`;
              
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue_number,
                body: resourceMessage,
              });
            }
  
  label-good-first-issues:
    name: Suggest Issues for New Contributors
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    
    steps:
      - name: Check if suitable for beginners
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const title = context.payload.issue.title.toLowerCase();
            const body = (context.payload.issue.body || '').toLowerCase();
            const content = `${title} ${body}`;
            
            // Check if issue is suitable for beginners
            const beginner_keywords = [
              'typo', 'documentation', 'docs', 'readme', 'comment',
              'simple', 'minor', 'small', 'easy', 'trivial'
            ];
            
            const isBeginner = beginner_keywords.some(keyword => content.includes(keyword));
            
            if (isBeginner && context.payload.issue.user.login !== context.repo.owner) {
              // Add good-first-issue label
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: issue_number,
                labels: ['good first issue'],
              });
              
              const message = `### ðŸŒŸ Good First Issue

This looks like a great issue for first-time contributors! 

If you're new to the project and want to contribute, this might be a good starting point. Feel free to ask questions if you need guidance!

---
*Automated suggestion by Welcome & Onboarding Premium Bot*`;
              
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue_number,
                body: message,
              });
            }
