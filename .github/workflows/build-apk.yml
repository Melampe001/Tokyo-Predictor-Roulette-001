name: Build Android APK and App Bundle

# Complete workflow for Tokyo Roulette by TokyoAppsÂ®
# Includes: Build, Test, QA, Visual Validation, and Release preparation

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type (debug/release)'
        required: false
        default: 'release'

permissions:
  contents: read

env:
  FLUTTER_VERSION: '3.16.0'

jobs:
  # Job 1: Static Analysis and Linting
  analyze:
    name: ðŸ” Static Analysis & Linting
    runs-on: ubuntu-latest
    steps:
    - name: Checkout del repositorio
      uses: actions/checkout@v4
    
    - name: Configurar Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: Obtener dependencias
      run: flutter pub get
    
    - name: AnÃ¡lisis estÃ¡tico (dart analyze)
      run: flutter analyze --no-fatal-infos
    
    - name: Verificar formato de cÃ³digo
      run: dart format --set-exit-if-changed lib/ test/
      continue-on-error: true
    
    - name: Verificar dependencias obsoletas
      run: flutter pub outdated
      continue-on-error: true

  # Job 2: Unit and Widget Tests
  test:
    name: ðŸ§ª Automated Tests
    runs-on: ubuntu-latest
    needs: analyze
    steps:
    - name: Checkout del repositorio
      uses: actions/checkout@v4
    
    - name: Configurar Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: Obtener dependencias
      run: flutter pub get
    
    - name: Ejecutar tests unitarios
      run: flutter test --coverage
    
    - name: Verificar cobertura de tests
      run: |
        echo "============================================"
        echo "ðŸ“Š Resumen de Tests"
        echo "============================================"
        if [ -f "coverage/lcov.info" ]; then
          echo "Archivo de cobertura generado"
          head -50 coverage/lcov.info || true
        fi

  # Job 3: Build APK (optimized)
  build-apk:
    name: ðŸ“¦ Build APK Release
    runs-on: ubuntu-latest
    needs: [analyze, test]
    outputs:
      apk_size: ${{ steps.apk_info.outputs.size }}
    steps:
    - name: Checkout del repositorio
      uses: actions/checkout@v4
    
    - name: Configurar JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Configurar Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: Verificar versiÃ³n de Flutter
      run: flutter --version
    
    - name: Obtener dependencias
      run: flutter pub get
    
    - name: Compilar APK Release (optimizado)
      run: |
        flutter build apk --release --shrink \
          --dart-define=APP_BRAND="TokyoAppsÂ®" \
          --dart-define=APP_SLOGAN="SimulaciÃ³n inteligente para entretenimiento"
    
    - name: InformaciÃ³n del APK
      id: apk_info
      run: |
        echo "============================================"
        echo "ðŸ“± APK Release - Tokyo Roulette"
        echo "============================================"
        if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
          SIZE=$(ls -lh build/app/outputs/flutter-apk/app-release.apk | awk '{print $5}')
          echo "âœ“ APK generada: $SIZE"
          echo "size=$SIZE" >> $GITHUB_OUTPUT
        else
          echo "âœ— Error: APK no encontrada"
          exit 1
        fi
    
    - name: Subir APK como artefacto
      uses: actions/upload-artifact@v4
      with:
        name: tokyo-roulette-apk-release
        path: build/app/outputs/flutter-apk/app-release.apk
        retention-days: 30

  # Job 4: Build App Bundle for Play Store
  build-bundle:
    name: ðŸ“¦ Build App Bundle (Play Store)
    runs-on: ubuntu-latest
    needs: [analyze, test]
    steps:
    - name: Checkout del repositorio
      uses: actions/checkout@v4
    
    - name: Configurar JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Configurar Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: Obtener dependencias
      run: flutter pub get
    
    - name: Compilar App Bundle para Play Store
      run: |
        flutter build appbundle --release \
          --dart-define=APP_BRAND="TokyoAppsÂ®" \
          --dart-define=APP_SLOGAN="SimulaciÃ³n inteligente para entretenimiento"
    
    - name: Verificar App Bundle
      run: |
        echo "============================================"
        echo "ðŸ“¦ App Bundle - Tokyo Roulette"
        echo "============================================"
        if [ -f "build/app/outputs/bundle/release/app-release.aab" ]; then
          SIZE=$(ls -lh build/app/outputs/bundle/release/app-release.aab | awk '{print $5}')
          echo "âœ“ App Bundle generado: $SIZE"
        else
          echo "âœ— Error: App Bundle no encontrado"
          exit 1
        fi
    
    - name: Subir App Bundle como artefacto
      uses: actions/upload-artifact@v4
      with:
        name: tokyo-roulette-appbundle
        path: build/app/outputs/bundle/release/app-release.aab
        retention-days: 30

  # Job 5: Branding Validation
  validate-branding:
    name: ðŸŽ¨ Validate Branding TokyoAppsÂ®
    runs-on: ubuntu-latest
    steps:
    - name: Checkout del repositorio
      uses: actions/checkout@v4
    
    - name: Validar branding en cÃ³digo
      run: |
        echo "============================================"
        echo "ðŸŽ¨ ValidaciÃ³n de Branding TokyoAppsÂ®"
        echo "============================================"
        
        # Verificar presencia de branding en archivos clave
        BRANDING_OK=true
        
        # Verificar AndroidManifest.xml
        if grep -q "TokyoAppsÂ®\|tokyoapps" android/app/src/main/AndroidManifest.xml; then
          echo "âœ“ Branding en AndroidManifest.xml"
        else
          echo "âš  Verificar branding en AndroidManifest.xml"
        fi
        
        # Verificar build.gradle
        if grep -q "tokyoapps" android/app/build.gradle; then
          echo "âœ“ Namespace de TokyoApps en build.gradle"
        else
          echo "âš  Verificar namespace en build.gradle"
        fi
        
        # Verificar pubspec.yaml
        if grep -q "tokyo" pubspec.yaml; then
          echo "âœ“ Nombre de app en pubspec.yaml"
        else
          echo "âš  Verificar nombre en pubspec.yaml"
        fi
        
        echo "============================================"
        echo "Slogan esperado: 'SimulaciÃ³n inteligente para entretenimiento'"
        echo "============================================"

  # Job 6: Generate Compliance Checklist
  compliance-checklist:
    name: ðŸ“‹ Generate Compliance Checklist
    runs-on: ubuntu-latest
    needs: [build-apk, build-bundle, validate-branding]
    steps:
    - name: Checkout del repositorio
      uses: actions/checkout@v4
    
    - name: Generar checklist de compliance
      run: |
        mkdir -p release-artifacts
        
        cat > release-artifacts/COMPLIANCE_CHECKLIST.md << 'EOF'
        # âœ… Tokyo Roulette - Checklist de Compliance para Google Play
        
        ## TokyoAppsÂ® - SimulaciÃ³n inteligente para entretenimiento
        
        ### ðŸ“± InformaciÃ³n de la App
        - **Nombre**: Tokyo Roulette
        - **Paquete**: com.tokyoapps.roulette
        - **VersiÃ³n**: 1.0.0
        - **Desarrollador**: TokyoAppsÂ®
        
        ---
        
        ### âœ… Requisitos de Play Store
        
        #### Metadatos
        - [ ] TÃ­tulo de la app (mÃ¡x 30 caracteres)
        - [ ] DescripciÃ³n corta (mÃ¡x 80 caracteres)
        - [ ] DescripciÃ³n completa (mÃ¡x 4000 caracteres)
        - [ ] CategorÃ­a: Entretenimiento / SimulaciÃ³n
        - [ ] ClasificaciÃ³n de contenido: Todos
        
        #### Assets GrÃ¡ficos
        - [ ] Ãcono de app (512x512 PNG)
        - [ ] GrÃ¡fico destacado (1024x500 PNG)
        - [ ] Screenshots telÃ©fono (mÃ­n 2, 16:9)
        - [ ] Screenshots tablet (mÃ­n 2, 16:9)
        
        #### PolÃ­ticas de Play Store
        - [ ] PolÃ­tica de privacidad URL
        - [ ] DeclaraciÃ³n de gambling/simulaciÃ³n
        - [ ] Disclaimer educativo visible
        - [ ] No promueve gambling real
        
        #### Branding TokyoAppsÂ®
        - [x] Logo TokyoAppsÂ® en Splash
        - [x] Slogan en pantalla About
        - [x] Metadatos de branding en app
        - [x] Namespace com.tokyoapps.roulette
        
        #### Requisitos TÃ©cnicos
        - [x] Target SDK 34 (Android 14)
        - [x] Min SDK 21 (Android 5.0)
        - [x] App Bundle generado
        - [x] APK de respaldo
        - [x] ProGuard habilitado
        - [x] OptimizaciÃ³n de recursos
        
        ---
        
        ### ðŸ“ Textos para Play Store
        
        **TÃ­tulo**: Tokyo Roulette - Simulador
        
        **DescripciÃ³n corta**: Simulador educativo de ruleta con predicciones inteligentes
        
        **DescripciÃ³n completa**:
        ```
        ðŸŽ° Tokyo Roulette by TokyoAppsÂ®
        
        Simulador educativo de ruleta europea con:
        
        âœ¨ CaracterÃ­sticas:
        â€¢ Generador de nÃºmeros aleatorios (RNG) certificado
        â€¢ Predicciones basadas en anÃ¡lisis estadÃ­stico
        â€¢ Estrategia Martingale simulada
        â€¢ Historial completo de resultados
        â€¢ Interfaz intuitiva y moderna
        
        ðŸ“š PropÃ³sito educativo:
        Esta aplicaciÃ³n es estrictamente para entretenimiento y 
        educaciÃ³n sobre probabilidades. No promueve ni facilita 
        apuestas reales.
        
        âš ï¸ Disclaimer:
        Tokyo Roulette es una simulaciÃ³n. Los resultados son 
        aleatorios y no pueden usarse para predecir resultados 
        en casinos reales.
        
        Â© TokyoAppsÂ® - SimulaciÃ³n inteligente para entretenimiento
        ```
        
        ---
        
        ### ðŸ“¸ Screenshots Requeridos
        
        1. Pantalla de inicio / Splash con branding TokyoAppsÂ®
        2. Pantalla principal de ruleta
        3. Resultado de giro con predicciÃ³n
        4. Historial de resultados
        5. Pantalla About con disclaimer
        
        ---
        
        Generado automÃ¡ticamente por CI/CD
        Fecha: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        EOF
        
        echo "âœ… Checklist de compliance generado"
    
    - name: Subir checklist como artefacto
      uses: actions/upload-artifact@v4
      with:
        name: compliance-checklist
        path: release-artifacts/
        retention-days: 90

  # Job 7: Release Summary
  release-summary:
    name: ðŸ“Š Release Summary
    runs-on: ubuntu-latest
    needs: [build-apk, build-bundle, compliance-checklist]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - name: Checkout del repositorio
      uses: actions/checkout@v4
    
    - name: Generar resumen de release
      run: |
        echo "============================================"
        echo "ðŸ“Š RESUMEN DE RELEASE - TOKYO ROULETTE"
        echo "============================================"
        echo ""
        echo "ðŸ·ï¸  VersiÃ³n: 1.0.0"
        echo "ðŸ“¦ Paquete: com.tokyoapps.roulette"
        echo "ðŸ¢ Desarrollador: TokyoAppsÂ®"
        echo ""
        echo "ðŸ“± Artefactos generados:"
        echo "   â€¢ APK Release (optimizado)"
        echo "   â€¢ App Bundle (Play Store)"
        echo "   â€¢ Checklist de compliance"
        echo ""
        echo "âœ… Validaciones completadas:"
        echo "   â€¢ AnÃ¡lisis estÃ¡tico"
        echo "   â€¢ Tests automatizados"
        echo "   â€¢ ValidaciÃ³n de branding"
        echo ""
        echo "ðŸ“ Siguiente paso:"
        echo "   Descargar artefactos y subir a Google Play Console"
        echo "============================================"