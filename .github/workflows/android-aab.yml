name: Build Android AAB (Secure)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-aab:
    name: Build Signed AAB
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "::error::Missing required secret: KEYSTORE_BASE64"
            exit 1
          fi
          if [ -z "${{ secrets.KEYSTORE_PASSWORD }}" ]; then
            echo "::error::Missing required secret: KEYSTORE_PASSWORD"
            exit 1
          fi
          if [ -z "${{ secrets.KEY_ALIAS }}" ]; then
            echo "::error::Missing required secret: KEY_ALIAS"
            exit 1
          fi
          if [ -z "${{ secrets.KEY_PASSWORD }}" ]; then
            echo "::error::Missing required secret: KEY_PASSWORD"
            exit 1
          fi
          echo "All required secrets are present"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install Flutter dependencies
        run: flutter pub get

      - name: Decode and setup keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          # Run the decode script
          bash scripts/decode-keystore.sh

          # Read the keystore path from the output file
          KEYSTORE_PATH=$(cat keystore_path.txt)
          echo "KEYSTORE_PATH=$KEYSTORE_PATH" >> $GITHUB_ENV

          # Mask the keystore path in logs
          echo "::add-mask::$KEYSTORE_PATH"

          # Verify keystore file exists and has correct permissions
          if [ ! -f "$KEYSTORE_PATH" ]; then
            echo "::error::Keystore file not found at $KEYSTORE_PATH"
            exit 1
          fi

          ls -la "$KEYSTORE_PATH"
          echo "Keystore successfully restored and secured"

      - name: Install Android SDK components
        run: |
          # Accept licenses
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true

          # Install required SDK components for building AAB
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0"

      - name: Build AAB with signing
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          # Mask secrets in logs
          echo "::add-mask::$KEYSTORE_PASSWORD"
          echo "::add-mask::$KEY_ALIAS"
          echo "::add-mask::$KEY_PASSWORD"

          # Build the signed AAB using Flutter
          flutter build appbundle \
            --release \
            --build-number=${{ github.run_number }} \
            --dart-define=KEYSTORE_PATH="$KEYSTORE_PATH" \
            --dart-define=KEYSTORE_PASSWORD="$KEYSTORE_PASSWORD" \
            --dart-define=KEY_ALIAS="$KEY_ALIAS" \
            --dart-define=KEY_PASSWORD="$KEY_PASSWORD"

          # Verify AAB was created
          AAB_PATH="build/app/outputs/bundle/release/app-release.aab"
          if [ ! -f "$AAB_PATH" ]; then
            echo "::error::AAB file not found at $AAB_PATH"
            exit 1
          fi

          echo "AAB built successfully: $AAB_PATH"
          ls -lh "$AAB_PATH"

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

      - name: Clean up keystore
        if: always()
        run: |
          # Securely remove keystore file
          if [ -f "$KEYSTORE_PATH" ]; then
            shred -vfz -n 3 "$KEYSTORE_PATH" 2>/dev/null || rm -f "$KEYSTORE_PATH"
          fi

          # Remove keystore path file
          rm -f keystore_path.txt

          echo "Keystore cleanup completed"
