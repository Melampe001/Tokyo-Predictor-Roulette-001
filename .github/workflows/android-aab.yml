name: Build Android AAB

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Validate required secrets
      run: |
        if [ -z "${{ secrets.KEYSTORE_BASE64 }}" ]; then
          echo "::error::KEYSTORE_BASE64 secret is not set. Please configure it in repository secrets."
          exit 1
        fi
        if [ -z "${{ secrets.KEYSTORE_PASSWORD }}" ]; then
          echo "::error::KEYSTORE_PASSWORD secret is not set. Please configure it in repository secrets."
          exit 1
        fi
        if [ -z "${{ secrets.KEY_ALIAS }}" ]; then
          echo "::error::KEY_ALIAS secret is not set. Please configure it in repository secrets."
          exit 1
        fi
        if [ -z "${{ secrets.KEY_PASSWORD }}" ]; then
          echo "::error::KEY_PASSWORD secret is not set. Please configure it in repository secrets."
          exit 1
        fi
        echo "All required secrets are configured."
    
    - name: Install Android SDK components
      run: |
        # Update SDK manager
        yes | sdkmanager --licenses || true
        sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.0"
    
    - name: Decode and restore keystore
      env:
        KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      run: |
        # Run the decode-keystore script and capture output
        KEYSTORE_PATH=$(./scripts/decode-keystore.sh)
        SCRIPT_EXIT=$?
        
        # Check if script succeeded
        if [ $SCRIPT_EXIT -ne 0 ]; then
          echo "::error::Keystore decode script failed with exit code $SCRIPT_EXIT"
          exit 1
        fi
        
        # Validate the keystore path exists
        if [ -z "$KEYSTORE_PATH" ] || [ ! -f "$KEYSTORE_PATH" ]; then
          echo "::error::Failed to create keystore file"
          exit 1
        fi
        
        # Ensure the path is in a temporary directory and doesn't contain path traversal
        # Resolve to absolute path and check it doesn't escape tmp
        REAL_PATH=$(readlink -f "$KEYSTORE_PATH" 2>/dev/null || echo "$KEYSTORE_PATH")
        case "$REAL_PATH" in
          /tmp/keystore.*.jks|"${TMPDIR}"keystore.*.jks)
            # Valid pattern: must be in /tmp or TMPDIR and match expected filename
            if [[ "$REAL_PATH" =~ \.\./  ]]; then
              echo "::error::Keystore path contains path traversal"
              rm -f "$KEYSTORE_PATH"
              exit 1
            fi
            echo "Keystore path validated: $KEYSTORE_PATH"
            ;;
          *)
            echo "::error::Keystore path is not in expected temporary directory format"
            rm -f "$KEYSTORE_PATH"
            exit 1
            ;;
        esac
        
        echo "KEYSTORE_PATH=$KEYSTORE_PATH" >> $GITHUB_ENV
        echo "::add-mask::$KEYSTORE_PATH"
    
    - name: Build AAB release
      env:
        ANDROID_KEYSTORE_PATH: ${{ env.KEYSTORE_PATH }}
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        # Mask sensitive information in logs
        echo "::add-mask::$KEYSTORE_PASSWORD"
        echo "::add-mask::$KEY_PASSWORD"
        
        # Grant execute permission to gradlew
        chmod +x ./gradlew
        
        # Build the release AAB with signing properties
        ./gradlew bundleRelease \
          -Pandroid.injected.signing.store.file="$ANDROID_KEYSTORE_PATH" \
          -Pandroid.injected.signing.store.password="$KEYSTORE_PASSWORD" \
          -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
          -Pandroid.injected.signing.key.password="$KEY_PASSWORD"
    
    - name: Upload AAB artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-release-aab
        path: app/build/outputs/bundle/release/*.aab
        if-no-files-found: error
    
    - name: Cleanup keystore
      if: always()
      run: |
        if [ -n "$KEYSTORE_PATH" ] && [ -f "$KEYSTORE_PATH" ]; then
          rm -f "$KEYSTORE_PATH"
          echo "Keystore cleaned up successfully."
        fi
