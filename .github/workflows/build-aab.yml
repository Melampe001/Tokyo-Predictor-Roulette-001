name: Build AAB and Artifacts

# Workflow para compilar AAB firmado para Google Play Store
# Este workflow genera el Android App Bundle necesario para publicaciÃ³n

on:
  # NOTA: El workflow NO se ejecuta en push a main porque el proyecto Flutter
  # aÃºn no tiene la estructura completa. Se activa solo en:
  # - Tags de versiÃ³n (cuando el proyecto estÃ© listo para release)
  # - Manualmente desde GitHub Actions
  push:
    tags:
      - 'v*'  # Ejecutar en tags de versiÃ³n (v1.0.0, v1.2.3, etc.)
  workflow_dispatch:  # Permite ejecuciÃ³n manual desde GitHub Actions

# Permisos necesarios
permissions:
  contents: read

jobs:
  build:
    name: Build AAB (Release)
    runs-on: ubuntu-latest
    
    env:
      JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64

    steps:
      # Paso 1: Checkout del cÃ³digo
      - name: Checkout
        uses: actions/checkout@v4

      # Paso 2: Configurar JDK 17 (requerido para Android Gradle Plugin moderno)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Paso 3: Configurar Flutter SDK
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      # Paso 4: Cache de Gradle para builds mÃ¡s rÃ¡pidos
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper/
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # Paso 5: Verificar versiones instaladas
      - name: Verify installations
        run: |
          flutter --version
          java -version

      # Paso 6: Obtener dependencias Flutter
      - name: Get dependencies
        run: flutter pub get

      # Paso 7: Decodificar keystore desde secrets
      # El keystore se almacena codificado en base64 en GitHub Secrets
      - name: Decode Keystore
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 --decode > android/app/keystore.jks
          echo "Keystore decoded successfully"

      # Paso 8: Crear key.properties para signing
      - name: Create key.properties
        if: ${{ secrets.KEYSTORE_PASSWORD != '' }}
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          cat > android/key.properties << EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=keystore.jks
          EOF
          echo "key.properties created successfully"

      # Paso 9: Analizar cÃ³digo
      - name: Analyze code
        run: flutter analyze --no-fatal-infos
        continue-on-error: true

      # Paso 10: Ejecutar tests
      - name: Run tests
        run: flutter test
        continue-on-error: true

      # Paso 11: Build AAB Release
      - name: Build AAB Release
        run: flutter build appbundle --release

      # Paso 12: Verificar que el AAB se generÃ³
      - name: Verify AAB
        run: |
          echo "Verificando AAB generado..."
          if [ -f "build/app/outputs/bundle/release/app-release.aab" ]; then
            echo "âœ“ AAB generado exitosamente"
            ls -lh build/app/outputs/bundle/release/app-release.aab
          else
            echo "âœ— Error: AAB no encontrado"
            exit 1
          fi

      # Paso 13: Upload AAB artifact
      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

      # Paso 14: Upload mapping.txt (para debugging de crashes)
      - name: Upload mapping.txt (R8/ProGuard)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mapping-release
          path: build/app/outputs/mapping/release/mapping.txt
          if-no-files-found: ignore

      # Paso 15: Upload native debug symbols
      - name: Upload native debug symbols
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: native-debug-symbols
          path: build/app/intermediates/merged_native_libs/release/out/lib/
          if-no-files-found: ignore

      # Paso 16: InformaciÃ³n final
      - name: Build Summary
        run: |
          echo "============================================"
          echo "ðŸŽ‰ BUILD COMPLETADO EXITOSAMENTE"
          echo "============================================"
          echo ""
          echo "ðŸ“¦ Artefactos generados:"
          echo "   - app-release-aab (Android App Bundle)"
          echo "   - mapping-release (ProGuard mapping)"
          echo "   - native-debug-symbols (Native symbols)"
          echo ""
          echo "ðŸ“‹ PrÃ³ximos pasos:"
          echo "   1. Descargar AAB desde la pestaÃ±a Artifacts"
          echo "   2. Subir a Google Play Console"
          echo "   3. Configurar release track (internal/closed/production)"
          echo "   4. Subir mapping.txt para crash reporting"
          echo "============================================"

      # Paso 17: Cleanup de archivos sensibles
      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f android/app/keystore.jks
          rm -f android/key.properties
          echo "Sensitive files cleaned up"

# ============================================
# CONFIGURACIÃ“N DE SECRETS REQUERIDOS
# ============================================
#
# Configura estos secrets en: Settings â†’ Secrets and variables â†’ Actions
#
# KEYSTORE_BASE64:
#   - Keystore codificado en base64
#   - Generar con: base64 -i your-keystore.jks -o keystore_base64.txt
#   - Copiar contenido del archivo al secret
#
# KEYSTORE_PASSWORD:
#   - ContraseÃ±a del keystore
#
# KEY_ALIAS:
#   - Alias de la key de signing
#
# KEY_PASSWORD:
#   - ContraseÃ±a de la key
#
# ============================================
# RECOMENDACIONES DE SEGURIDAD
# ============================================
#
# 1. USA GOOGLE PLAY APP SIGNING:
#    - Deja que Google maneje tu key de release
#    - TÃº solo mantienes la upload key
#    - MÃ¡s seguro y permite recuperaciÃ³n
#
# 2. NUNCA COMMITS EL KEYSTORE:
#    - Usa secrets de GitHub
#    - O almacenamiento seguro externo
#
# 3. ROTA KEYS REGULARMENTE:
#    - Especialmente si hay rotaciÃ³n de equipo
#
# 4. BACKUP DEL KEYSTORE:
#    - Guarda copia segura offline
#    - Sin keystore no puedes actualizar la app
#
# ============================================
